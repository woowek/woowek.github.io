---
title: 
parent: Documents
layout: default
---

# 

> Source: `지난 프로젝트/경기도청/1. 컨테이너 구성.md`

---

> 컨테이너 구성
---
- 여기에 모든 작업 과정을 다 적게될지는 모르겠지만 일단 다 적어본다..




- Application 분석
    * 담당자 말만듣고 작업을 하니 제대로 되는게 없었다...
    * apache wordpress의 경우 wp_config / egovframework의 경우 global.config 확인
    * 클래스파일 배포라면 반드시 디컴파일 후 소스분석을 하자..
    * java 디컴파일
        - 난 파워쉘로 디컴파일 처리를 했다. cfr-0.151.jar 다운로드 후 작성 후 실행
        ```ps
        $src = "원본경로"
        $out = "디컴파일 후 저장경로"
        mkdir $out -Force
        Get-ChildItem -Path $src -Recurse -Filter *.class | ForEach-Object {
            $rel = $_.FullName.Substring($src.Length+1).Replace('\','.').Replace('.class','')
            $outFile = Join-Path $out ($_.FullName.Substring($src.Length+1) -replace '\\','.').Replace('.class','.java')
            java -jar "cfr-0.151.jar 경로" $_.FullName --outputdir $out
        }
        ```

- Dockerfile
    * 기본 베이스 이미지를 기준으로 작업했다.
    * 대략 구성은 다음과 같다. 아파치쪽이 훨씬 어렵다.
        - apache
            1. apache
            2. 타임존 설정 변경
            3. /usr/local/etc/php/conf.d/custom.ini 재설정
            4. /etc/apache2/sites-available/000-default.conf 재설정
            5. /etc/apache2/ 설정 파일 변경
            6. exec apache2-foreground 실행 
        - tomcat
            1. 베이스 이미지
            2. 타임존 설정 변경
            3. tomcat/webapps 폴더 제거
            4. 웹 소스 git 저장소 -> 이미지로 이동
            5. tomcat/conf 이동
            6. 포트 지정
            7. catalina.sh 실행
    * sample
        - apache
        ```dockerfile
        FROM harbor 저장소/baseimg/base:php7.4

        ENV TZ=Asia/Seoul

        RUN if [ -f /usr/share/zoneinfo/Asia/Seoul ]; then \\
            cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime; \\
            elif [ -f /tmp/Asia_Seoul ]; then \\
            cp /tmp/Asia_Seoul /etc/localtime; \\
            else \\
            true; \\
            fi

        RUN a2enmod rewrite \\
            && a2enmod headers \\
            && a2enmod expires \\
            && a2enmod ssl \\
            && a2enmod setenvif

        RUN { \\
            echo 'upload_max_filesize = 64M'; \\
            echo 'post_max_size = 64M'; \\
            echo 'memory_limit = 256M'; \\
            echo 'max_execution_time = 300'; \\
            echo 'max_input_time = 300'; \\
            echo 'date.timezone = Asia/Seoul'; \\
            echo 'opcache.enable = 1'; \\
            echo 'opcache.memory_consumption = 128'; \\
            echo 'opcache.interned_strings_buffer = 8'; \\
            echo 'opcache.max_accelerated_files = 10000'; \\
            echo 'opcache.revalidate_freq = 2'; \\
        } > /usr/local/etc/php/conf.d/custom.ini

        ENV APACHE_DOCUMENT_ROOT /var/www/html/web/htdocs

        RUN cat > /etc/apache2/sites-available/000-default.conf <<'EOF'
        <VirtualHost *:80>
            ServerAdmin webmaster@localhost
            ServerName "서비스 host url"

            DocumentRoot /var/www/html/web/htdocs
            SetEnv HTTPS on

            ErrorLog "|/usr/bin/rotatelogs -l /mnt/logs/apache2/error-%Y-%m-%d.log 86400"
            CustomLog "|/usr/bin/rotatelogs -l /mnt/logs/apache2/access-%Y-%m-%d.log 86400" combined
        </VirtualHost>
        EOF

        RUN sed -i 's|\${APACHE_DOCUMENT_ROOT}|\${APACHE_DOCUMENT_ROOT}|g' /etc/apache2/sites-available/*.conf /etc/apache2/sites-enabled/*.conf /etc/apache2/conf-available/*.conf /etc/apache2/apache2.conf 2>/dev/null || true \\
        && sed -i 's#<Directory[[:space:]]*>#<Directory /var/www/html/web/htdocs>#g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf 2>/dev/null || true

        RUN echo 'ServerName "서비스 host url"' >> /etc/apache2/apache2.conf || true \\
        && echo 'SetEnv HTTPS on' >> /etc/apache2/apache2.conf || true
                
        WORKDIR /var/www/html

        COPY web /var/www/html/web

        RUN chown -R www-data:www-data /var/www/html \\
            && find /var/www/html -type d -exec chmod 755 {} \\; \\
            && find /var/www/html -type f -exec chmod 644 {} \\;

        EXPOSE 80 443

        CMD ["/bin/sh", "-c", "mkdir -p /mnt/logs/apache2 && chmod 777 /mnt/logs/apache2 && touch /mnt/logs/apache2/init-\$(date +%Y-%m-%d).log && tail -n 0 -F /mnt/logs/apache2/*.log & exec apache2-foreground"]
        ```
        - tomcat
        ```dockerfile
        FROM harbor 저장소/baseimg/tomcat:7.0-jre8

        ENV TZ=Asia/Seoul
        ENV CATALINA_OPTS="-Xms256m -Xmx1024m -Dfile.encoding=UTF-8 -Duser.timezone=Asia/Seoul"

        RUN rm -rf /usr/local/tomcat/webapps/*

        COPY "웹 소스 저장소 위치" "tomcat 웹 저장 위치"
        RUN chmod -R 755 "tomcat 웹 저장 위치" || true

        COPY /tomcat/conf /usr/local/tomcat/conf
        RUN chmod -R 755 /usr/local/tomcat/conf || true

        RUN if [ -f /usr/share/zoneinfo/Asia/Seoul ]; then \\
            cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime; \\
            elif [ -f /tmp/Asia_Seoul ]; then \\
            cp /tmp/Asia_Seoul /etc/localtime; \\
            else \\
            true; \\
            fi

        EXPOSE 8080

        CMD ["catalina.sh", "run"]
        ```



- deployment
    * 로깅처리 사이드카의 경우 별도 설명한다.
    * 일반적인 deployment에 이미지를 넣고, pv 마운트하는 일반적인 구조이다.
    * 굳이 내용을 쓸 이유도 없을듯

- ingress
    * tls를 적용하기 위한 ingress이다. 
    * secret에 tls를 등록했고, rules/host에 접속대상 URL을 적는다.
    * replicas가 2 이상일 경우 sticky session으로 적용한다..
    ```yaml
      annotations:
        kubernetes.io/ingress.class: nginx-link
        nginx.ingress.kubernetes.io/rewrite-target: /$1
        nginx.ingress.kubernetes.io/use-regex: "true"
        nginx.ingress.kubernetes.io/affinity: cookie
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        nginx.ingress.kubernetes.io/session-cookie-name: INGRESSCOOKIE
        nginx.ingress.kubernetes.io/session-cookie-path: /
        nginx.ingress.kubernetes.io/ssl-redirect: "true"
    ```
    * 서비스가 리버스프록시를 통한 서비스라면 상위 URL도 다 등록해줘야한다.