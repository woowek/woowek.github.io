---
title: 
parent: Documents
layout: default
---

# 

> Source: `지난 프로젝트/경기도청/2. 로깅처리.md`

---

> 로깅처리
---
- 망분리 이슈 및 사용자 기능 부여의 한계때문에 사용자들이 로그를 볼 수 없는 이슈가 있어 로깅 서버를 별도로 구축했었다..
- 대충 로직은 다음과 같다.
    * 서비스 컨테이너 구성
    * 로깅 처리를 위한 사이드카 구성 (아래에 부연설명하겠으나 결론적으로 cronjob 쓰는게 더 낫다..)
    * 로그 pv 마운트 (서비스 컨테이너, 사이드카 동일 PV 마운트)
    * 사이드카 컨테이너에서 주기적으로 로그서버에 로그 폴더 rsync 및 오래된 파일 삭제


- 작업 내용은 다음과 같다.
    * alpine-rsync-find 이미지는 alpine 기본이미지에 rsync와 findutil 설치 후 export한 이미지
    * deployment
    ```yaml
        - name: log-sidecar
          image: 사이드카 이미지 경로
          imagePullPolicy: Always
          volumeMounts:
            - name: log-volume
              mountPath: /logs
              readOnly: false
            - name: ssh-key-volume
              mountPath: /etc/secret
              readOnly: true
    ```
    * sidecar
    ```dockerfile
    FROM harbor 저장소/baseimg/alpine-rsync-find:latest

    ENV TZ=Asia/Seoul
    RUN if [ -f /usr/share/zoneinfo/Asia/Seoul ]; then \\
        cp /usr/share/zoneinfo/Asia/Seoul /etc/localtime; \\
        elif [ -f /tmp/Asia_Seoul ]; then \\
        cp /tmp/Asia_Seoul /etc/localtime; \\
        else \\
        true; \\
        fi

    WORKDIR /app

    RUN cat > /app/entrypoint.sh <<'EOF'
    #!/bin/sh
    if [ -f /etc/secret/id_rsa ]; then
        cp /etc/secret/id_rsa /tmp/id_rsa
        chmod 600 /tmp/id_rsa
    fi
    DELAY=\$(( RANDOM % 100 ))
    sleep \$DELAY
    while true; do
        find /logs/ -type f -mtime +180 -exec rm -f {} \\;
        rsync -avz --delete -e "ssh -p 2102 -i /tmp/id_rsa -o StrictHostKeyChecking=no" \\
            /logs/ \\
            "rsync 전송 대상 서버 및 경로"
        sleep 300
    done
    EOF

    RUN chmod +x /app/entrypoint.sh

    CMD ["/app/entrypoint.sh"]
    ```



- 일단 작업한건 이런데.. 이렇게 등록하는게 더 낫긴 하다.. 작업 다 끝나니까 생각났네..
    * cronjob
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: log-sync
  namespace: ns
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: log-sync
            image: harbor 저장소/baseimg/alpine-rsync-find:latest
            imagePullPolicy: Always
            env:
            - name: TZ
              value: Asia/Seoul
            command:
            - /bin/sh
            - -c
            - |
              if [ -f /etc/secret/id_rsa ]; then
                  cp /etc/secret/id_rsa /tmp/id_rsa
                  chmod 600 /tmp/id_rsa
              fi
              find /logs/ -type f -mtime +180 -exec rm -f {} \;
              rsync -avz --delete -e "ssh -p 2102 -i /tmp/id_rsa -o StrictHostKeyChecking=no" \
                  /logs/ \
                  "rsync 전송 대상 서버 및 경로"
            volumeMounts:
            - name: log-volume
              mountPath: /logs
              readOnly: false
            - name: ssh-key-volume
              mountPath: /etc/secret
              readOnly: true
          restartPolicy: OnFailure
          volumes:
          - name: log-volume
            persistentVolumeClaim:
              claimName: log-pvc
          - name: ssh-key-volume
            secret:
              secretName: rsync-ssh-key
              defaultMode: 0400
          imagePullSecrets:
          - name: harborcred    
```

